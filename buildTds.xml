<?xml version="1.0" encoding="UTF-8"?>
<project name="ncWMS for TDS" default="cleanPushSrcJarToThreddsWorkingCopy" basedir=".">
    <description>Build ncwms.jar for use by TDS.</description>

  <tstamp>
    <format property="build.time" pattern="yyyy-MM-dd HH:mm:ss" timezone="GMT"/>
    <format property="build.time.number" pattern="yyyyMMdd.HHmm" timezone="GMT"/>
  </tstamp>
  <property name="build.number" value="${build.time.number}" />
  <property name="build.name" value="${build.number}" />

  <property name="release.version" value="4.2"/>
  <property name="release.version.minor" value="${release.version}.${build.number}"/>
  <property name="release.dir.name" value="${release.version}.${build.name}"/>

  <property  name="ncwmsForTds.release.version" value="1.0.tds.${release.version.minor}" />

  <property name="javac.debug" value="true" />
  <property name="javac.debuglevel" value="lines,vars,source" />

  <property name="src.dir" location="${basedir}/src/java"/>
  <property name="test-src.dir" location="${basedir}/test"/>
  <property name="lib.dir" location="${basedir}/web/WEB-INF/lib"/>
  <property name="extra-lib.dir" location="${basedir}/lib"/>
  <property name="build.dir" value="${basedir}/target"/>
  <property name="build.classes.dir" value="${build.dir}/classes"/>
  <property name="build.test-classes.dir" value="${build.dir}/test-classes"/>

  <path id="source.path">
    <pathelement location="${src.dir}"/>
  </path>

  <path id="test-source.path">
    <pathelement location="${test-src.dir}"/>
  </path>

  <patternset id="sources">
    <include name="uk/ac/rdg/resc/ncwms/**/*.java"/>
    <!--exclude name="uk/ac/rdg/resc/ncwms/controller/ServerConfig.java"/-->
    <exclude name="uk/ac/rdg/resc/ncwms/cache/**/*.java"/>
    <exclude name="uk/ac/rdg/resc/ncwms/config/**/*.java"/>
    <exclude name="uk/ac/rdg/resc/ncwms/security/**/*.java"/>
    <exclude name="uk/ac/rdg/resc/ncwms/usagelog/h2/**/*.java"/>
  </patternset>

  <patternset id="test-sources">
    <include name="uk/ac/rdg/resc/ncwms/**/*.java"/>
  </patternset>

  <fileset id="compile.libraries" dir="${lib.dir}">
    <patternset id="compile.libs">
      <exclude name="bufr-1.4.jar" />
      <exclude name="grib-8.0.jar" />
      <exclude name="h2.jar" />
      <exclude name="hsqldb-1.8.0.7.jar" />
    </patternset>
  </fileset>

  <path id="compile.classpath">
    <fileset refid="compile.libraries" />
    <fileset file="${extra-lib.dir}/servlet-api.jar" />
  </path>

  <path id="test-compile.classpath">
    <pathelement path="${build.classes.dir}" />
    <fileset refid="compile.libraries" />
    <fileset file="${extra-lib.dir}/junit-4.10.jar" />
  </path>

  <path id="test.classpath">
    <pathelement path="${build.test-classes.dir}" />
    <pathelement path="${build.classes.dir}" />
    <fileset refid="compile.libraries" />
    <fileset file="${extra-lib.dir}/junit-4.10.jar" />
  </path>

  <target name="init">
    <mkdir dir="${build.classes.dir}"/>
    <mkdir dir="${build.test-classes.dir}"/>
    <echo message="Initialize ${ant.project.name}"/>
  </target>

  <target name="clean" description="Deletes all files that are generated by the build.">
    <delete dir="${build.dir}" failonerror="false"/>
  </target>

  <target name="compile" depends="init" description="compile ncwms for TDS">
    <javac destdir="${build.classes.dir}" source="1.6" target="1.6"
           debug="${javac.debug}" debuglevel="${javac.debuglevel}"
           includeAntRuntime="false">
      <src refid="source.path"/>
      <patternset refid="sources"/>
      <classpath refid="compile.classpath"/>
    </javac>
  </target>

  <target name="test-compile" depends="compile" description="compile ncwms tests">
    <javac destdir="${build.test-classes.dir}" source="1.6" target="1.6"
           debug="${javac.debug}" debuglevel="${javac.debuglevel}"
           includeAntRuntime="false">
      <src refid="test-source.path" />
      <patternset refid="test-sources" />
      <classpath refid="test-compile.classpath" />
    </javac>
  </target>

  <target name="test" depends="test-compile" description="run ncwms tests">
    <junit haltonfailure="yes" showoutput="yes" printsummary="yes">
      <classpath refid="test.classpath"/>
      <batchtest>
        <fileset dir="${build.test-classes.dir}" includes="**/*Test.class" />
        <formatter type="plain" usefile="false" />
      </batchtest>
    </junit>
  </target>

  <property name="ncwms.jar" value="${build.dir}/ncwms.jar" />
  <property name="ncwms.src.jar" value="${build.dir}/ncwms-src.jar" />

  <target  name="buildNcwmsJar" description="Create ncwms.jar (assumes already compiled).">
    <jar destfile="${ncwms.jar}">
      <fileset dir="${build.classes.dir}"/>

      <manifest>
        <attribute name="Built-By" value="Unidata - ${user.name}"/>
        <attribute name="Built-On" value="${build.time}"/>
        <attribute name="Implementation-Title" value="ncWMS for TDS"/>
        <attribute name="Implementation-Version" value="${ncwmsForTds.release.version}"/>
        <attribute name="Implementation-Vendor" value="University of Reading"/>
      </manifest>
    </jar>
  </target>

  <target  name="buildNcwmsSrc" description="Create ncwms-src.jar.">
    <jar destfile="${ncwms.src.jar}">
      <fileset dir="${src.dir}">
        <patternset refid="sources"/>
      </fileset>

      <manifest>
        <attribute name="Built-By" value="Unidata - ${user.name}"/>
        <attribute name="Built-On" value="${build.time}"/>
        <attribute name="Implementation-Title" value="Source of ncWMS for TDS"/>
        <attribute name="Implementation-Version" value="${ncwmsForTds.release.version}"/>
        <attribute name="Implementation-Vendor" value="University of Reading"/>
      </manifest>
    </jar>
  </target>
  <target  name="cleanBuildNcwmsSrcAndJar" depends="clean, compile, test-compile, test, buildNcwmsSrc, buildNcwmsJar" />

  <property name="tds.lib.dir" value="../thredds/lib/release" />
  <property name="tds.lib.src.dir" value="${tds.lib.dir}/source" />

  <target name="pushSrcJarToThreddsWorkingCopy">
    <copy todir="${tds.lib.dir}" file="${ncwms.jar}"
          preservelastmodified="true" overwrite="true" />
    <copy todir="${tds.lib.src.dir}" file="${ncwms.src.jar}"
          preservelastmodified="true" overwrite="true" />
  </target>
  <target name="cleanPushSrcJarToThreddsWorkingCopy" depends="cleanBuildNcwmsSrcAndJar,pushSrcJarToThreddsWorkingCopy" />

</project>
